# åç«¯ä»£ç æ¡†æ¶ä¸åŠŸèƒ½ç»“æ„åˆ†æ

## ğŸ“Š é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®åç§°**: å­¦ç”Ÿä¿¡æ¯æœåŠ¡å¹³å° (Student Information Service Platform)  
**åç«¯æ¡†æ¶**: FastAPI 3.0.0  
**æ•°æ®åº“**: MySQL 5.7+  
**ORM**: SQLAlchemy 2.x  
**ä¸»è¦åŠŸèƒ½**: å­¦ç”Ÿæˆæœç®¡ç†ã€AIè¯ä¹¦è¯†åˆ«ã€æ™ºèƒ½å¯¹è¯åŠ©æ‰‹

---

## ğŸ—ï¸ ä»£ç æ¶æ„

### ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ main.py                 # FastAPIåº”ç”¨å…¥å£
â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†ï¼ˆç¯å¢ƒå˜é‡ï¼‰
â”œâ”€â”€ database.py            # æ•°æ®åº“è¿æ¥é…ç½®
â”œâ”€â”€ models.py              # SQLAlchemyæ•°æ®æ¨¡å‹
â”œâ”€â”€ schemas.py             # Pydanticæ•°æ®éªŒè¯æ¨¡å‹
â”œâ”€â”€ auth.py                # JWTè®¤è¯å·¥å…·
â”œâ”€â”€ utils.py               # é€šç”¨å·¥å…·å‡½æ•°
â”œâ”€â”€ dependencies.py        # FastAPIä¾èµ–æ³¨å…¥
â”œâ”€â”€ init_db.py             # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ requirements.txt       # Pythonä¾èµ–åŒ…
â”‚
â”œâ”€â”€ routers/               # APIè·¯ç”±æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ auth.py           # è®¤è¯è·¯ç”±
â”‚   â”œâ”€â”€ common.py         # å…¬å…±è·¯ç”±ï¼ˆæ•™å¸ˆã€ä¸Šä¼ ï¼‰
â”‚   â”œâ”€â”€ student.py        # å­¦ç”Ÿç«¯è·¯ç”±
â”‚   â”œâ”€â”€ admin.py          # ç®¡ç†å‘˜è·¯ç”±
â”‚   â””â”€â”€ certificate.py    # è¯ä¹¦è¯†åˆ«è·¯ç”±
â”‚
â”œâ”€â”€ services/              # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ file_manager.py               # æ–‡ä»¶ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ image_preprocessor.py         # å›¾åƒé¢„å¤„ç†
â”‚   â”œâ”€â”€ certificate_recognition.py    # è¯ä¹¦è¯†åˆ«ï¼ˆåŸç‰ˆï¼‰
â”‚   â””â”€â”€ certificate_recognition_openai.py  # è¯ä¹¦è¯†åˆ«ï¼ˆOpenAIå…¼å®¹ï¼‰
â”‚
â”œâ”€â”€ middleware/            # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ certificate_access.py  # è¯ä¹¦è®¿é—®æ§åˆ¶
â”‚
â””â”€â”€ uploads/               # æ–‡ä»¶ä¸Šä¼ ç›®å½•
    â””â”€â”€ students/          # å­¦ç”Ÿæ–‡ä»¶ç›®å½•
        â””â”€â”€ {student_id}/
            â””â”€â”€ certificates/
```

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—åˆ†æ

### 1. åº”ç”¨å…¥å£ (main.py)

**èŒè´£**: FastAPIåº”ç”¨åˆå§‹åŒ–ã€è·¯ç”±æ³¨å†Œã€ä¸­é—´ä»¶é…ç½®

**å…³é”®ä»£ç **:
```python
app = FastAPI(
    title="Student Information Service Platform API",
    version="3.0.0"
)

# CORSä¸­é—´ä»¶
app.add_middleware(CORSMiddleware, ...)

# è¯ä¹¦è®¿é—®æ§åˆ¶ä¸­é—´ä»¶
app.add_middleware(CertificateAccessMiddleware)

# é™æ€æ–‡ä»¶æœåŠ¡
app.mount("/uploads", StaticFiles(directory="./uploads"))

# è·¯ç”±æ³¨å†Œ
app.include_router(auth.router)
app.include_router(common.router)
app.include_router(student.router)
app.include_router(admin.router)
app.include_router(certificate.router)
```

**å¯åŠ¨äº‹ä»¶**:
- æ•°æ®åº“åˆå§‹åŒ–ï¼š`init_db()`

---

### 2. é…ç½®ç®¡ç† (config.py)

**èŒè´£**: ä»ç¯å¢ƒå˜é‡åŠ è½½é…ç½®

**é…ç½®é¡¹åˆ†ç±»**:

| ç±»åˆ« | é…ç½®é¡¹ | é»˜è®¤å€¼ |
|------|--------|--------|
| æ•°æ®åº“ | `DATABASE_URL` | `mysql+pymysql://...` |
| JWT | `SECRET_KEY`, `ALGORITHM` | HS256ç®—æ³• |
| æ–‡ä»¶ä¸Šä¼  | `UPLOAD_DIR`, `MAX_FILE_SIZE` | 10MBé™åˆ¶ |
| AIæœåŠ¡ | `QWEN_API_KEY`, `QWEN_VL_MODEL` | qwen-vl-max |
| CORS | `ALLOWED_ORIGINS` | localhost:3000,8080 |

**æŠ€æœ¯äº®ç‚¹**:
- ä½¿ç”¨ `pydantic-settings` è‡ªåŠ¨åŠ è½½ `.env` æ–‡ä»¶
- `@field_validator` è‡ªåŠ¨è§£æé€—å·åˆ†éš”çš„URLåˆ—è¡¨

---

### 3. æ•°æ®æ¨¡å‹ (models.py)

**èŒè´£**: å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„

#### è¡¨ç»“æ„å…³ç³»å›¾

```
sys_users (ç”¨æˆ·è¡¨)
    â†“ 1:1
sys_students (å­¦ç”Ÿè¡¨) â† N:1 â†’ biz_achievements (æˆæœè¡¨) â† 1:N â†’ sys_teachers (æ•™å¸ˆè¡¨)
    â†“ 1:N
ai_chat_sessions (å¯¹è¯ä¼šè¯)
    â†“ 1:N
ai_chat_messages (å¯¹è¯æ¶ˆæ¯)
```

#### æ ¸å¿ƒæ¨¡å‹

**1. SysUser (ç³»ç»Ÿç”¨æˆ·)**
```python
- id: Integer (ä¸»é”®)
- username: String(50, unique)
- password_hash: String(255)
- role: Enum(student/admin)
- avatar_url: String(500)
```

**2. SysStudent (å­¦ç”Ÿæ¡£æ¡ˆ)**
```python
- id: Integer (ä¸»é”®)
- user_id: Integer (å¤–é”® â†’ sys_users.id)
- student_number: String(20, unique)
- name: String(50)
- major: String(100)
- persona_cache: JSON  # AIç”Ÿæˆçš„ç”»åƒæ•°æ®
```

**3. BizAchievement (æˆæœè®°å½•)**
```python
- id: Integer (ä¸»é”®)
- student_id: Integer (å¤–é”® â†’ sys_students.id)
- teacher_id: Integer (å¤–é”® â†’ sys_teachers.id)
- title: String(200)
- type: String(50)  # competition/paper/patent/project/certificate
- content_json: JSON  # OCRè¯†åˆ«ç»“æœ
- evidence_url: String(500)
- status: Enum(pending/approved/rejected)
- audit_comment: Text
- created_at: DateTime
```

**4. AiChatSession (å¯¹è¯ä¼šè¯)**
```python
- id: String(36)  # UUID
- student_id: Integer (å¤–é”®)
- title: String(200)
- updated_at: DateTime
```

**5. AiChatMessage (å¯¹è¯æ¶ˆæ¯)**
```python
- id: Integer (ä¸»é”®)
- session_id: String(36) (å¤–é”®)
- role: Enum(user/assistant)
- content: Text
- created_at: DateTime
```

---

### 4. æ•°æ®éªŒè¯æ¨¡å‹ (schemas.py)

**èŒè´£**: Pydanticæ¨¡å‹ï¼Œç”¨äºAPIè¯·æ±‚/å“åº”éªŒè¯

**æ ‡å‡†å“åº”æ¨¡å‹**:
```python
class ResponseModel(BaseModel):
    code: int = 200
    msg: str = "success"
    data: Optional[Any] = None
```

**å…³é”®æ¨¡å‹**:

| æ¨¡å‹ | ç”¨é€” |
|------|------|
| `LoginRequest/Response` | ç™»å½• |
| `AchievementCreate` | åˆ›å»ºæˆæœ |
| `AchievementResponse` | æˆæœå“åº”ï¼ˆå¸¦å…³è”æ•°æ®ï¼‰ |
| `AchievementAudit` | å®¡æ ¸æ“ä½œ |
| `ChatRequest/Response` | AIå¯¹è¯ |
| `PersonaResponse` | å­¦ç”Ÿç”»åƒ |

---

### 5. è®¤è¯ç³»ç»Ÿ (auth.py + dependencies.py)

#### auth.py - JWTå·¥å…·

```python
def create_access_token(data: dict) -> str:
    """ç”ŸæˆJWT Token"""
    
def verify_password(plain_password, hashed_password) -> bool:
    """éªŒè¯å¯†ç ï¼ˆbcryptï¼‰"""
    
def get_password_hash(password) -> str:
    """ç”Ÿæˆå¯†ç å“ˆå¸Œ"""
```

#### dependencies.py - ä¾èµ–æ³¨å…¥

```python
async def get_current_user(token: str) -> SysUser:
    """è§£æTokenï¼Œè·å–å½“å‰ç”¨æˆ·"""
    
async def require_student(user: SysUser) -> SysStudent:
    """è¦æ±‚å­¦ç”Ÿè§’è‰²"""
    
async def require_admin(user: SysUser) -> SysUser:
    """è¦æ±‚ç®¡ç†å‘˜è§’è‰²"""
```

**ä½¿ç”¨æ–¹å¼**:
```python
@router.get("/achievements")
async def get_my_achievements(
    student: SysStudent = Depends(require_student)
):
    # student å·²é€šè¿‡è®¤è¯å¹¶éªŒè¯è§’è‰²
```

---

### 6. è·¯ç”±æ¨¡å—è¯¦è§£

#### routers/auth.py - è®¤è¯è·¯ç”±

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/v1/auth/login` | POST | ç”¨æˆ·ç™»å½• |

**æ ¸å¿ƒé€»è¾‘**:
1. éªŒè¯ç”¨æˆ·åå¯†ç 
2. ç”ŸæˆJWT Token (æœ‰æ•ˆæœŸ24å°æ—¶)
3. è¿”å›Token + ç”¨æˆ·ä¿¡æ¯

---

#### routers/common.py - å…¬å…±è·¯ç”±

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/v1/common/teachers` | GET | è·å–æ•™å¸ˆåˆ—è¡¨ |
| `/api/v1/common/upload` | POST | æ–‡ä»¶ä¸Šä¼  |

**æ–‡ä»¶ä¸Šä¼ æµç¨‹**:
1. éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§10MBï¼‰
2. ç”ŸæˆUUIDæ–‡ä»¶å
3. ä¿å­˜åˆ° `uploads/` ç›®å½•
4. è¿”å›è®¿é—®URL

---

#### routers/student.py - å­¦ç”Ÿè·¯ç”±

**æ ¸å¿ƒç«¯ç‚¹**:

1. **è¯ä¹¦OCRè¯†åˆ«** (`POST /ocr/recognize`)
   - è°ƒç”¨ `file_manager.save_certificate_permanent()` ä¿å­˜æ–‡ä»¶
   - è°ƒç”¨ `certificate_recognition_service_openai.recognize_certificate()` è¯†åˆ«
   - è¿”å›è¯†åˆ«æ•°æ® + æ–‡ä»¶URL

2. **æäº¤æˆæœ** (`POST /achievements`)
   - éªŒè¯æ•™å¸ˆå­˜åœ¨
   - éªŒè¯è¯ä¹¦è®¿é—®æƒé™
   - åˆ›å»ºæˆæœè®°å½•ï¼ˆçŠ¶æ€é»˜è®¤pendingï¼‰

3. **è·å–æˆæœåˆ—è¡¨** (`GET /achievements`)
   - æŸ¥è¯¢å½“å‰å­¦ç”Ÿçš„æˆæœ
   - æ”¯æŒæŒ‰çŠ¶æ€ç­›é€‰

4. **AIå¯¹è¯** (`POST /ai/chat`)
   - è·å–æˆ–åˆ›å»ºä¼šè¯ï¼ˆUUIDï¼‰
   - ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
   - æ£€ç´¢å†å²ä¸Šä¸‹æ–‡ï¼ˆæœ€è¿‘10æ¡ï¼‰
   - æ£€ç´¢å­¦ç”Ÿæˆæœä½œä¸ºRAGä¸Šä¸‹æ–‡
   - è°ƒç”¨LLM APIï¼ˆTODO: å½“å‰ä¸ºmockï¼‰
   - ä¿å­˜AIå“åº”

5. **å­¦ç”Ÿç”»åƒ** (`GET /persona`)
   - æ£€æŸ¥ç¼“å­˜æœ‰æ•ˆæ€§ï¼ˆ7å¤©ï¼‰
   - å¦‚éœ€é‡æ–°ç”Ÿæˆï¼Œè°ƒç”¨LLMåˆ†ææˆæœï¼ˆTODO: å½“å‰ä¸ºmockï¼‰
   - è¿”å›ç”»åƒæ•°æ®

---

#### routers/admin.py - ç®¡ç†å‘˜è·¯ç”±

**æ ¸å¿ƒç«¯ç‚¹**:

1. **è·å–æˆæœå®¡æ ¸åˆ—è¡¨** (`GET /achievements`)
   - æ”¯æŒçŠ¶æ€ç­›é€‰
   - æ”¯æŒå­¦ç”Ÿå§“åæ¨¡ç³Šæœç´¢
   - åˆ†é¡µæŸ¥è¯¢ï¼ˆé»˜è®¤10æ¡/é¡µï¼‰
   - JOINæŸ¥è¯¢å­¦ç”Ÿã€æ•™å¸ˆä¿¡æ¯

2. **å®¡æ ¸æˆæœ** (`PATCH /achievements/{id}/audit`)
   - éªŒè¯action (approve/reject)
   - æ‹’ç»æ—¶å¿…é¡»å¡«å†™comment
   - é€šè¿‡æ—¶ï¼Œæ¸…ç©ºå­¦ç”Ÿç”»åƒç¼“å­˜

---

#### routers/certificate.py - è¯ä¹¦è¯†åˆ«è·¯ç”±

**ç‹¬ç«‹æœåŠ¡**ï¼Œä¸ä¿å­˜æ–‡ä»¶åˆ°æ•°æ®åº“ï¼š

1. **å•ä¸ªè¯†åˆ«** (`POST /recognize`)
   - ä¸´æ—¶ä¿å­˜åˆ° `temp_certificates/`
   - è¯†åˆ«åè‡ªåŠ¨åˆ é™¤

2. **æ‰¹é‡è¯†åˆ«** (`POST /batch-recognize`)
   - æœ€å¤š10ä¸ªæ–‡ä»¶
   - è¿”å›æ¯ä¸ªæ–‡ä»¶çš„è¯†åˆ«ç»“æœ

3. **å¥åº·æ£€æŸ¥** (`GET /health`)
   - æ£€æŸ¥AIæœåŠ¡é…ç½®çŠ¶æ€

---

### 7. æœåŠ¡å±‚ (services/)

#### file_manager.py - æ–‡ä»¶ç®¡ç†

**æ ¸å¿ƒæ–¹æ³•**:

```python
async def save_certificate_permanent(file, student_id):
    """æ°¸ä¹…ä¿å­˜è¯ä¹¦åˆ°å­¦ç”Ÿç›®å½•"""
    # è·¯å¾„: uploads/students/{student_id}/certificates/{uuid}.ext
    
def verify_certificate_access(file_url, student_id, is_admin):
    """éªŒè¯æ–‡ä»¶è®¿é—®æƒé™"""
    
def get_student_certificates(student_id):
    """è·å–å­¦ç”Ÿæ‰€æœ‰è¯ä¹¦"""
```

**ç›®å½•ç»“æ„**:
```
uploads/
â””â”€â”€ students/
    â”œâ”€â”€ 1/
    â”‚   â””â”€â”€ certificates/
    â”‚       â”œâ”€â”€ abc123.jpg
    â”‚       â””â”€â”€ def456.png
    â””â”€â”€ 2/
        â””â”€â”€ certificates/
```

---

#### certificate_recognition_openai.py - è¯ä¹¦è¯†åˆ«æœåŠ¡

**æ ¸å¿ƒæµç¨‹**:

1. **å›¾åƒé¢„å¤„ç†**: 
   - è°ƒç”¨ `image_preprocessor.preprocess_image()`
   - å‹ç¼©ã€æ ¼å¼è½¬æ¢

2. **è°ƒç”¨AIæ¨¡å‹**:
   - æ¨¡å‹: `qwen-vl-max`
   - API: OpenAIå…¼å®¹æ¥å£
   - å‘é€å›¾ç‰‡ + æç¤ºè¯

3. **ç»“æœè§£æ**:
   - è§£æJSONå“åº”
   - éªŒè¯å¿…éœ€å­—æ®µ
   - è®¡ç®—ç½®ä¿¡åº¦

**æç¤ºè¯è®¾è®¡**:
```python
prompt = """
è¯·è¯†åˆ«è¿™å¼ è·å¥–è¯ä¹¦ï¼Œæå–ä»¥ä¸‹ä¿¡æ¯ï¼š
1. è¯ä¹¦åç§°
2. è·å¥–äººå§“å
3. é¢å‘æœºæ„
4. é¢å‘æ—¥æœŸ
5. è¯ä¹¦ç¼–å·
6. è·å¥–ç­‰çº§
7. é¡¹ç›®/å›¢é˜Ÿä¿¡æ¯
...
ä»¥JSONæ ¼å¼è¿”å›
"""
```

---

### 8. ä¸­é—´ä»¶ (middleware/)

#### certificate_access.py - è¯ä¹¦è®¿é—®æ§åˆ¶

**åŠŸèƒ½**: æ‹¦æˆª `/uploads/students/` è·¯å¾„çš„è¯·æ±‚ï¼ŒéªŒè¯æƒé™

**é€»è¾‘**:
```python
if request.url.path.startswith("/uploads/students/"):
    # è§£æstudent_id
    # éªŒè¯å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºè¯¥å­¦ç”Ÿæˆ–ç®¡ç†å‘˜
    if not has_access:
        return JSONResponse(status_code=403, content={...})
```

**å®‰å…¨æ€§**:
- å­¦ç”Ÿåªèƒ½è®¿é—®è‡ªå·±çš„è¯ä¹¦
- ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰è¯ä¹¦
- é˜²æ­¢è·¨å­¦ç”Ÿæ–‡ä»¶è®¿é—®

---

## ğŸ”„ æ•°æ®æµåˆ†æ

### æˆæœæäº¤å®Œæ•´æµç¨‹

```
å‰ç«¯ â†’ åç«¯
1. ä¸Šä¼ è¯ä¹¦ (POST /api/v1/student/ocr/recognize)
   â†“
   file_manager.save_certificate_permanent()
   - ç”ŸæˆUUIDæ–‡ä»¶å
   - ä¿å­˜åˆ° uploads/students/{student_id}/certificates/
   â†“
   certificate_recognition_service.recognize_certificate()
   - é¢„å¤„ç†å›¾ç‰‡
   - è°ƒç”¨qwen-vl-max API
   - è§£æè¿”å›JSON
   â†“
   è¿”å›: file_url + recognized_data
   â†“
2. å‰ç«¯å±•ç¤ºè¯†åˆ«ç»“æœï¼Œç”¨æˆ·ç¡®è®¤
   â†“
3. æäº¤æˆæœ (POST /api/v1/student/achievements)
   â†“
   éªŒè¯teacher_idå­˜åœ¨
   â†“
   éªŒè¯evidence_urlè®¿é—®æƒé™
   â†“
   åˆ›å»ºBizAchievementè®°å½•
   - status = pending
   - content_json = è¯†åˆ«æ•°æ®
   â†“
   è¿”å›: achievement_id
```

---

### æˆæœå®¡æ ¸å®Œæ•´æµç¨‹

```
ç®¡ç†å‘˜ç«¯ â†’ åç«¯
1. è·å–å¾…å®¡æ ¸åˆ—è¡¨ (GET /api/v1/admin/achievements?status=pending)
   â†“
   æŸ¥è¯¢ BizAchievement
   JOIN SysStudent, SysTeacher
   â†“
   è¿”å›: æˆæœåˆ—è¡¨ï¼ˆå«å­¦ç”Ÿã€æ•™å¸ˆåï¼‰
   â†“
2. ç®¡ç†å‘˜æŸ¥çœ‹è¯¦æƒ…ï¼Œç‚¹å‡»å®¡æ ¸
   â†“
3. å®¡æ ¸æ“ä½œ (PATCH /api/v1/admin/achievements/{id}/audit)
   â†“
   if action == "approve":
     - achievement.status = APPROVED
     - student.persona_cache = None  # æ¸…ç©ºç¼“å­˜
   else:
     - achievement.status = REJECTED
     - ä¿å­˜ audit_comment
   â†“
   è¿”å›: success
```

---

### AIå¯¹è¯å®Œæ•´æµç¨‹

```
å­¦ç”Ÿç«¯ â†’ åç«¯
1. å‘é€æ¶ˆæ¯ (POST /api/v1/student/ai/chat)
   â†“
   if session_id is None:
     - åˆ›å»ºæ–°ä¼šè¯ï¼ˆUUIDï¼‰
   else:
     - éªŒè¯ä¼šè¯å½’å±
   â†“
   ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° ai_chat_messages
   â†“
   æ£€ç´¢ä¸Šä¸‹æ–‡
   - æœ€è¿‘10æ¡å†å²æ¶ˆæ¯
   - å­¦ç”Ÿå·²å®¡æ ¸é€šè¿‡çš„æˆæœ
   â†“
   æ„å»ºLLMè¯·æ±‚
   - system prompt: "ä½ æ˜¯å­¦ä¸šå¯¼å¸ˆï¼Œå­¦ç”Ÿæˆæœï¼š..."
   - user message
   â†“
   è°ƒç”¨LLM API (TODO: å½“å‰mock)
   â†“
   ä¿å­˜AIå“åº”åˆ° ai_chat_messages
   â†“
   æ›´æ–°ä¼šè¯ updated_at
   â†“
   è¿”å›: session_id + AIæ¶ˆæ¯
```

---

## ğŸ¯ è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ

### 1. ä¾èµ–æ³¨å…¥ (Dependency Injection)

FastAPIåŸç”Ÿæ”¯æŒï¼Œç”¨äºï¼š
- æ•°æ®åº“ä¼šè¯ç®¡ç† (`get_db`)
- ç”¨æˆ·è®¤è¯ (`get_current_user`)
- è§’è‰²éªŒè¯ (`require_student`, `require_admin`)

**ä¼˜åŠ¿**:
- ä»£ç è§£è€¦
- ä¾¿äºæµ‹è¯•ï¼ˆå¯æ³¨å…¥mockå¯¹è±¡ï¼‰

---

### 2. ä»“åº“æ¨¡å¼ (Repository Pattern)

è™½ç„¶æœªæ˜¾å¼å®ç°ï¼Œä½†é€šè¿‡SQLAlchemy ORMå®ç°äº†ç±»ä¼¼æ•ˆæœï¼š
- `db.query(Model).filter(...).all()`

**å»ºè®®ä¼˜åŒ–**:
å¯ä»¥æå–ä¸ºç‹¬ç«‹çš„ä»“åº“ç±»ï¼š
```python
class AchievementRepository:
    def get_by_student(self, student_id, status=None):
        query = db.query(BizAchievement).filter(...)
        return query.all()
```

---

### 3. æœåŠ¡å±‚æ¨¡å¼ (Service Layer)

- `services/file_manager.py`: æ–‡ä»¶ç®¡ç†é€»è¾‘
- `services/certificate_recognition_openai.py`: AIè¯†åˆ«é€»è¾‘

**ä¼˜åŠ¿**:
- ä¸šåŠ¡é€»è¾‘ä¸è·¯ç”±åˆ†ç¦»
- å¯å¤ç”¨

---

### 4. ä¸­é—´ä»¶æ¨¡å¼ (Middleware)

- `CORSMiddleware`: è·¨åŸŸå¤„ç†
- `CertificateAccessMiddleware`: æ–‡ä»¶è®¿é—®æ§åˆ¶

**ä¼˜åŠ¿**:
- ç»Ÿä¸€å¤„ç†æ¨ªåˆ‡å…³æ³¨ç‚¹
- ä¸æ±¡æŸ“ä¸šåŠ¡ä»£ç 

---

### 5. ç»Ÿä¸€å“åº”æ ¼å¼

æ‰€æœ‰APIéƒ½ä½¿ç”¨ï¼š
```python
{
  "code": 200,
  "msg": "success",
  "data": {...}
}
```

**å·¥å…·å‡½æ•°**:
```python
def success_response(data, msg="success"):
    return {"code": 200, "msg": msg, "data": data}
    
def error_response(msg, code=400, data=None):
    return {"code": code, "msg": msg, "data": data}
```

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. è®¤è¯
- JWT Tokenè®¤è¯
- æœ‰æ•ˆæœŸ24å°æ—¶
- HS256ç­¾åç®—æ³•

### 2. æˆæƒ
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- å­¦ç”Ÿ/ç®¡ç†å‘˜æƒé™éš”ç¦»

### 3. å¯†ç å®‰å…¨
- bcryptå“ˆå¸Œ
- ä¸å­˜å‚¨æ˜æ–‡å¯†ç 

### 4. æ–‡ä»¶è®¿é—®æ§åˆ¶
- ä¸­é—´ä»¶éªŒè¯è¯ä¹¦è®¿é—®æƒé™
- å­¦ç”Ÿåªèƒ½è®¿é—®è‡ªå·±çš„æ–‡ä»¶

### 5. SQLæ³¨å…¥é˜²æŠ¤
- ä½¿ç”¨SQLAlchemy ORM
- å‚æ•°åŒ–æŸ¥è¯¢

### 6. CORSé…ç½®
- ç™½åå•æœºåˆ¶
- ä»…å…è®¸é…ç½®çš„å‰ç«¯åŸŸå

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“
- ç´¢å¼•ä¼˜åŒ–ï¼ˆè§models.pyï¼‰
- è¿æ¥æ± ï¼ˆ`pool_pre_ping=True`ï¼‰

### 2. ç¼“å­˜
- å­¦ç”Ÿç”»åƒç¼“å­˜ï¼ˆpersona_cacheï¼‰
- é¿å…é‡å¤LLMè°ƒç”¨

### 3. å¼‚æ­¥IO
- FastAPIåŸç”Ÿå¼‚æ­¥æ”¯æŒ
- `async def` è·¯ç”±å‡½æ•°

---

## ğŸ“ å¾…ä¼˜åŒ–ç‚¹

### 1. AIåŠŸèƒ½æœªå®Œæˆ
- âœ… è¯ä¹¦OCRå·²å®ç°
- âš ï¸ AIå¯¹è¯ä½¿ç”¨mockæ•°æ®ï¼ˆéœ€é…ç½®LLM APIï¼‰
- âš ï¸ å­¦ç”Ÿç”»åƒä½¿ç”¨mockæ•°æ®ï¼ˆéœ€é…ç½®LLM APIï¼‰

### 2. ç¼“å­˜æœºåˆ¶
- å»ºè®®å¼•å…¥Redisç¼“å­˜
- ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼ˆæ•™å¸ˆåˆ—è¡¨ã€æˆæœç»Ÿè®¡ï¼‰

### 3. å¼‚æ­¥ä»»åŠ¡
- ç”»åƒç”Ÿæˆåº”ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡ï¼ˆCeleryï¼‰
- é¿å…é˜»å¡APIå“åº”

### 4. æ—¥å¿—ç³»ç»Ÿ
- æ·»åŠ ç»“æ„åŒ–æ—¥å¿—ï¼ˆloggingï¼‰
- è®°å½•å…³é”®æ“ä½œå®¡è®¡

### 5. å•å…ƒæµ‹è¯•
- æ·»åŠ pytestæµ‹è¯•ç”¨ä¾‹
- æé«˜ä»£ç è¦†ç›–ç‡

---

## ğŸ” æŠ€æœ¯äº®ç‚¹

1. **FastAPIç°ä»£åŒ–**
   - è‡ªåŠ¨ç”ŸæˆOpenAPIæ–‡æ¡£
   - ç±»å‹æç¤º + PydanticéªŒè¯
   - é«˜æ€§èƒ½ï¼ˆåŸºäºStarlette + Uvicornï¼‰

2. **AIé›†æˆ**
   - é€šä¹‰åƒé—®å¤šæ¨¡æ€æ¨¡å‹
   - OpenAIå…¼å®¹æ¥å£è®¾è®¡
   - çµæ´»çš„æç¤ºè¯å·¥ç¨‹

3. **RESTfulè®¾è®¡**
   - æ¸…æ™°çš„èµ„æºå±‚æ¬¡
   - æ ‡å‡†HTTPæ–¹æ³•
   - ç»Ÿä¸€å“åº”æ ¼å¼

4. **æƒé™ç»†ç²’åº¦æ§åˆ¶**
   - åŸºäºè§’è‰²çš„è·¯ç”±ä¿æŠ¤
   - åŸºäºæ‰€æœ‰æƒçš„æ–‡ä»¶è®¿é—®æ§åˆ¶

5. **å¯æ‰©å±•æ¶æ„**
   - æ¨¡å—åŒ–è®¾è®¡
   - æœåŠ¡å±‚åˆ†ç¦»
   - æ¾è€¦åˆ

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| æ¨¡å— | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•°ï¼ˆä¼°ç®—ï¼‰ |
|------|--------|------------------|
| è·¯ç”±å±‚ | 5 | ~800 |
| æ•°æ®æ¨¡å‹ | 1 | ~120 |
| æœåŠ¡å±‚ | 4 | ~600 |
| ä¸­é—´ä»¶ | 1 | ~100 |
| é…ç½®/å·¥å…· | 5 | ~200 |
| **æ€»è®¡** | **16** | **~1820** |

---

## ğŸ“ å­¦ä¹ å»ºè®®

### å¯¹å‰ç«¯å¼€å‘è€…
1. ç†Ÿæ‚‰REST APIè°ƒç”¨è§„èŒƒ
2. ç†è§£JWTè®¤è¯æµç¨‹
3. æŒæ¡æ–‡ä»¶ä¸Šä¼ æœ€ä½³å®è·µ
4. äº†è§£åˆ†é¡µã€ç­›é€‰ç­‰é€šç”¨åŠŸèƒ½

### å¯¹åç«¯å¼€å‘è€…
1. å­¦ä¹ FastAPIä¾èµ–æ³¨å…¥
2. ç†è§£SQLAlchemy ORMå…³ç³»æ˜ å°„
3. æŒæ¡Pydanticæ•°æ®éªŒè¯
4. ç†Ÿæ‚‰ä¸­é—´ä»¶å¼€å‘

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-01-28  
**åˆ†æå·¥å…·**: Antigravity AI
