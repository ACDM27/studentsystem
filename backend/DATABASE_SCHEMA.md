# æ•°æ®åº“ç»“æ„æ–‡æ¡£

## æ•°æ®åº“ä¿¡æ¯
- **æ•°æ®åº“ç±»å‹**: MySQL
- **ORM**: SQLAlchemy
- **è¿æ¥é…ç½®**: `mysql+pymysql://root:password@localhost:3306/student_system`

---

## æ•°æ®è¡¨ç»“æ„

### ğŸ“Š æ ¸å¿ƒè¡¨æ¦‚è§ˆ

| åºå· | è¡¨å | ä¸­æ–‡åç§° | ç”¨é€” | è®°å½•æ•°ï¼ˆæµ‹è¯•ï¼‰ |
|------|------|----------|------|----------------|
| 1 | `sys_users` | ç³»ç»Ÿç”¨æˆ·è¡¨ | å­˜å‚¨ç™»å½•è´¦å·ä¿¡æ¯ | 3+ |
| 2 | `sys_teachers` | æ•™å¸ˆåŸºç¡€æ•°æ®è¡¨ | å­˜å‚¨æ•™å¸ˆä¿¡æ¯ | 3+ |
| 3 | `sys_students` | å­¦ç”Ÿæ¡£æ¡ˆè¡¨ | å­˜å‚¨å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯ | 2+ |
| 4 | `biz_achievements` | æˆæœè¡¨ | å­˜å‚¨å­¦ç”Ÿæˆæœè®°å½• | åŠ¨æ€ |
| 5 | `ai_chat_sessions` | AIä¼šè¯è¡¨ | å­˜å‚¨å¯¹è¯ä¼šè¯ | åŠ¨æ€ |
| 6 | `ai_chat_messages` | AIæ¶ˆæ¯è®°å½•è¡¨ | å­˜å‚¨å¯¹è¯æ¶ˆæ¯ | åŠ¨æ€ |

---

## 1. sys_users (ç³»ç»Ÿç”¨æˆ·è¡¨)

**ç”¨é€”**: å­˜å‚¨ç³»ç»Ÿç™»å½•è´¦å·ä¿¡æ¯ï¼Œæ”¯æŒå­¦ç”Ÿå’Œç®¡ç†å‘˜ä¸¤ç§è§’è‰²

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | çº¦æŸ | ç´¢å¼• | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|------|--------|------|
| `id` | Integer | - | PRIMARY KEY | âœ“ | AUTO_INCREMENT | ç”¨æˆ·ID |
| `username` | String | 50 | UNIQUE, NOT NULL | âœ“ | - | ç”¨æˆ·åï¼ˆç™»å½•è´¦å·ï¼‰ |
| `password_hash` | String | 255 | NOT NULL | - | - | å¯†ç å“ˆå¸Œï¼ˆbcryptï¼‰ |
| `role` | Enum | - | NOT NULL | - | - | ç”¨æˆ·è§’è‰² (student/admin) |
| `avatar_url` | String | 500 | NULLABLE | - | NULL | å¤´åƒURL |
| `created_at` | DateTime | - | - | - | UTC NOW | åˆ›å»ºæ—¶é—´ |

**æšä¸¾ç±»å‹ - UserRole**:
- `student`: å­¦ç”Ÿ
- `admin`: ç®¡ç†å‘˜

**å…³ç³»**:
- ä¸€å¯¹ä¸€å…³è” `sys_students` (studentå­—æ®µ)

**æµ‹è¯•æ•°æ®**:
```
admin / admin123 (ç®¡ç†å‘˜)
student001 / password123 (å¼ ä¸‰)
student002 / password123 (æå››)
```

---

## 2. sys_teachers (æ•™å¸ˆåŸºç¡€æ•°æ®è¡¨)

**ç”¨é€”**: å­˜å‚¨æ•™å¸ˆåŸºç¡€ä¿¡æ¯ï¼Œç”¨äºæˆæœæŒ‡å¯¼æ•™å¸ˆå…³è”

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | çº¦æŸ | ç´¢å¼• | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|------|--------|------|
| `id` | Integer | - | PRIMARY KEY | âœ“ | AUTO_INCREMENT | æ•™å¸ˆID |
| `name` | String | 50 | NOT NULL | - | - | æ•™å¸ˆå§“å |
| `title` | String | 50 | NULLABLE | - | NULL | èŒç§°ï¼ˆæ•™æˆ/è®²å¸ˆç­‰ï¼‰ |
| `department` | String | 100 | NULLABLE | - | NULL | é™¢ç³» |

**å…³ç³»**:
- ä¸€å¯¹å¤šå…³è” `biz_achievements` (achievementså­—æ®µ)

**æµ‹è¯•æ•°æ®**:
```
ææ•™æˆ - æ•™æˆ - è®¡ç®—æœºå­¦é™¢
ç‹è®²å¸ˆ - è®²å¸ˆ - è½¯ä»¶å­¦é™¢
å¼ å‰¯æ•™æˆ - å‰¯æ•™æˆ - äººå·¥æ™ºèƒ½å­¦é™¢
```

---

## 3. sys_students (å­¦ç”Ÿæ¡£æ¡ˆè¡¨)

**ç”¨é€”**: å­˜å‚¨å­¦ç”Ÿçš„è¯¦ç»†æ¡£æ¡ˆä¿¡æ¯ï¼ŒåŒ…æ‹¬AIç”Ÿæˆçš„ç”»åƒæ•°æ®

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | çº¦æŸ | ç´¢å¼• | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|------|--------|------|
| `id` | Integer | - | PRIMARY KEY | âœ“ | AUTO_INCREMENT | å­¦ç”ŸID |
| `user_id` | Integer | - | FOREIGN KEY, UNIQUE, NOT NULL | - | - | å…³è”sys_users.id |
| `student_number` | String | 20 | UNIQUE, NOT NULL | âœ“ | - | å­¦å· |
| `name` | String | 50 | NOT NULL | - | - | å­¦ç”Ÿå§“å |
| `major` | String | 100 | NULLABLE | - | NULL | ä¸“ä¸š |
| `persona_cache` | JSON | - | NULLABLE | - | NULL | AIç”Ÿæˆçš„å­¦ç”Ÿç”»åƒç¼“å­˜ |

**å…³ç³»**:
- ä¸€å¯¹ä¸€å…³è” `sys_users` (userå­—æ®µ)
- ä¸€å¯¹å¤šå…³è” `biz_achievements` (achievementså­—æ®µ)
- ä¸€å¯¹å¤šå…³è” `ai_chat_sessions` (chat_sessionså­—æ®µ)

**persona_cache JSONç»“æ„ç¤ºä¾‹**:
```json
{
  "strengths": ["æ•°å­¦å»ºæ¨¡", "åˆ›æ–°èƒ½åŠ›"],
  "achievements_summary": "å‚ä¸å¤šé¡¹ç«èµ›å¹¶è·å¥–",
  "suggested_improvements": ["åŠ å¼ºè‹±è¯­èƒ½åŠ›", "æ‹“å±•è·¨å­¦ç§‘çŸ¥è¯†"],
  "generated_at": "2026-01-19T01:10:00Z"
}
```

**æµ‹è¯•æ•°æ®**:
```
2021001 - å¼ ä¸‰ - è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯
2021002 - æå›› - è½¯ä»¶å·¥ç¨‹
```

---

## 4. biz_achievements (æˆæœè¡¨)

**ç”¨é€”**: å­˜å‚¨å­¦ç”Ÿæäº¤çš„æˆæœè®°å½•ï¼Œæ”¯æŒå®¡æ ¸æµç¨‹

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | çº¦æŸ | ç´¢å¼• | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|------|--------|------|
| `id` | Integer | - | PRIMARY KEY | âœ“ | AUTO_INCREMENT | æˆæœID |
| `student_id` | Integer | - | FOREIGN KEY, NOT NULL | âœ“ | - | å…³è”sys_students.id |
| `teacher_id` | Integer | - | FOREIGN KEY, NOT NULL | âœ“ | - | å…³è”sys_teachers.idï¼ˆæŒ‡å¯¼æ•™å¸ˆï¼‰ |
| `title` | String | 200 | NOT NULL | - | - | æˆæœæ ‡é¢˜ |
| `type` | String | 50 | NOT NULL | - | - | æˆæœç±»å‹ï¼ˆå­—å…¸å€¼ï¼‰ |
| `content_json` | JSON | - | NULLABLE | - | NULL | OCRè¯†åˆ«çš„ç»“æ„åŒ–æ•°æ® |
| `evidence_url` | String | 500 | NULLABLE | - | NULL | è¯ä¹¦å›¾ç‰‡URL |
| `status` | Enum | - | NOT NULL | âœ“ | pending | å®¡æ ¸çŠ¶æ€ |
| `audit_comment` | Text | - | NULLABLE | - | NULL | å®¡æ ¸æ„è§ |
| `created_at` | DateTime | - | NOT NULL | âœ“ | UTC NOW | åˆ›å»ºæ—¶é—´ |

**æšä¸¾ç±»å‹ - AchievementStatus**:
- `pending`: å¾…å®¡æ ¸
- `approved`: å·²é€šè¿‡
- `rejected`: å·²æ‹’ç»

**content_json JSONç»“æ„ç¤ºä¾‹** (OCRè¯†åˆ«ç»“æœ):
```json
{
  "certificate_name": "å…¨å›½å¤§å­¦ç”Ÿæ•°å­¦å»ºæ¨¡ç«èµ›ä¸€ç­‰å¥–",
  "recipient_name": "å¼ ä¸‰",
  "issuing_organization": "ä¸­å›½å·¥ä¸šä¸åº”ç”¨æ•°å­¦å­¦ä¼š",
  "issue_date": "2023-12-01",
  "certificate_number": "CUMCM2023-A-001",
  "award_level": "å›½å®¶çº§ä¸€ç­‰å¥–",
  "category": "å­¦ç§‘ç«èµ›",
  "additional_info": "å›¢é˜Ÿæˆå‘˜ï¼šå¼ ä¸‰ã€æå››ã€ç‹äº”"
}
```

**å…³ç³»**:
- å¤šå¯¹ä¸€å…³è” `sys_students` (studentå­—æ®µ)
- å¤šå¯¹ä¸€å…³è” `sys_teachers` (teacherå­—æ®µ)

**æˆæœç±»å‹ (typeå­—æ®µ) å¸¸è§å€¼**:
- `competition`: å­¦ç§‘ç«èµ›
- `paper`: è®ºæ–‡å‘è¡¨
- `patent`: ä¸“åˆ©
- `project`: é¡¹ç›®
- `certificate`: èŒä¸šè¯ä¹¦

---

## 5. ai_chat_sessions (AIä¼šè¯è¡¨)

**ç”¨é€”**: å­˜å‚¨AIå¯¼å¸ˆå¯¹è¯çš„ä¼šè¯ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | çº¦æŸ | ç´¢å¼• | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|------|--------|------|
| `id` | String | 36 | PRIMARY KEY | - | - | ä¼šè¯ID (UUIDæ ¼å¼) |
| `student_id` | Integer | - | FOREIGN KEY, NOT NULL | âœ“ | - | å…³è”sys_students.id |
| `title` | String | 200 | NULLABLE | - | NULL | ä¼šè¯æ ‡é¢˜/æ‘˜è¦ |
| `updated_at` | DateTime | - | NOT NULL | - | UTC NOW | æœ€åæ›´æ–°æ—¶é—´ |

**å…³ç³»**:
- å¤šå¯¹ä¸€å…³è” `sys_students` (studentå­—æ®µ)
- ä¸€å¯¹å¤šå…³è” `ai_chat_messages` (messageså­—æ®µ, æŒ‰created_atæ’åº)

**ä¼šè¯IDæ ¼å¼**: UUID v4
```
ç¤ºä¾‹: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
```

---

## 6. ai_chat_messages (AIæ¶ˆæ¯è®°å½•è¡¨)

**ç”¨é€”**: å­˜å‚¨AIå¯¹è¯çš„è¯¦ç»†æ¶ˆæ¯è®°å½•ï¼Œæ”¯æŒä¸Šä¸‹æ–‡ç®¡ç†

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | çº¦æŸ | ç´¢å¼• | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|------|--------|------|
| `id` | Integer | - | PRIMARY KEY | âœ“ | AUTO_INCREMENT | æ¶ˆæ¯ID |
| `session_id` | String | 36 | FOREIGN KEY, NOT NULL | âœ“ | - | å…³è”ai_chat_sessions.id |
| `role` | Enum | - | NOT NULL | - | - | æ¶ˆæ¯è§’è‰² (user/assistant) |
| `content` | Text | - | NOT NULL | - | - | æ¶ˆæ¯å†…å®¹ |
| `created_at` | DateTime | - | NOT NULL | âœ“ | UTC NOW | åˆ›å»ºæ—¶é—´ |

**æšä¸¾ç±»å‹ - MessageRole**:
- `user`: ç”¨æˆ·å‘é€çš„æ¶ˆæ¯
- `assistant`: AIåŠ©æ‰‹å›å¤çš„æ¶ˆæ¯

**å…³ç³»**:
- å¤šå¯¹ä¸€å…³è” `ai_chat_sessions` (sessionå­—æ®µ)

---

## æ•°æ®åº“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   sys_users     â”‚
â”‚  (ç³»ç»Ÿç”¨æˆ·è¡¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1:1
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  sys_students   â”‚â—„â”€â”€â”    â”‚   sys_teachers   â”‚
â”‚  (å­¦ç”Ÿæ¡£æ¡ˆè¡¨)    â”‚   â”‚    â”‚  (æ•™å¸ˆåŸºç¡€æ•°æ®è¡¨) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1:N        â”‚             â”‚
         â”‚            â”‚ N:1         â”‚ 1:N
         â”‚            â”‚             â”‚
         â”‚       â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â”‚       â”‚  biz_achievements     â”‚
         â”‚       â”‚     (æˆæœè¡¨)          â”‚
         â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ai_chat_sessions â”‚
â”‚   (AIä¼šè¯è¡¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ai_chat_messages â”‚
â”‚  (AIæ¶ˆæ¯è®°å½•è¡¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç´¢å¼•ç­–ç•¥

### ä¸»é”®ç´¢å¼• (PRIMARY KEY)
æ‰€æœ‰è¡¨çš„ `id` å­—æ®µ

### å”¯ä¸€ç´¢å¼• (UNIQUE)
- `sys_users.username`: ä¿è¯ç”¨æˆ·åå”¯ä¸€
- `sys_users.id` â†” `sys_students.user_id`: ä¸€å¯¹ä¸€å…³è”
- `sys_students.student_number`: ä¿è¯å­¦å·å”¯ä¸€

### æ™®é€šç´¢å¼• (INDEX)
- `sys_users.id`: ä¸»é”®ç´¢å¼•
- `sys_users.username`: ç™»å½•æŸ¥è¯¢åŠ é€Ÿ
- `sys_students.id`: ä¸»é”®ç´¢å¼•
- `sys_students.student_number`: å­¦å·æŸ¥è¯¢åŠ é€Ÿ
- `biz_achievements.student_id`: å­¦ç”ŸæˆæœæŸ¥è¯¢åŠ é€Ÿ
- `biz_achievements.teacher_id`: æ•™å¸ˆæˆæœæŸ¥è¯¢åŠ é€Ÿ
- `biz_achievements.status`: æŒ‰çŠ¶æ€ç­›é€‰åŠ é€Ÿ
- `biz_achievements.created_at`: æ—¶é—´æ’åºåŠ é€Ÿ
- `ai_chat_sessions.student_id`: ä¼šè¯æŸ¥è¯¢åŠ é€Ÿ
- `ai_chat_messages.session_id`: æ¶ˆæ¯æŸ¥è¯¢åŠ é€Ÿ
- `ai_chat_messages.created_at`: æ¶ˆæ¯æ’åºåŠ é€Ÿ

---

## åˆå§‹åŒ–è„šæœ¬

### åˆ›å»ºæ•°æ®åº“
```sql
CREATE DATABASE student_system 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

### è‡ªåŠ¨åˆå§‹åŒ–
```bash
cd backend
python init_db.py
```

æ­¤è„šæœ¬å°†ï¼š
1. åˆ›å»ºæ‰€æœ‰è¡¨ç»“æ„
2. æ’å…¥æµ‹è¯•æ•°æ®ï¼ˆç®¡ç†å‘˜ã€æ•™å¸ˆã€å­¦ç”Ÿï¼‰

---

## æ•°æ®è¿ç§»

### ä½¿ç”¨ Alembic (æ¨è)
```bash
# åˆå§‹åŒ–è¿ç§»ç¯å¢ƒ
alembic init alembic

# åˆ›å»ºè¿ç§»
alembic revision --autogenerate -m "Initial migration"

# æ‰§è¡Œè¿ç§»
alembic upgrade head
```

### ç›´æ¥ä½¿ç”¨ SQLAlchemy
```python
from database import init_db
init_db()  # åˆ›å»ºæ‰€æœ‰è¡¨
```

---

## æ³¨æ„äº‹é¡¹

âš ï¸ **ç”Ÿäº§ç¯å¢ƒå»ºè®®**:

1. **å®‰å…¨æ€§**
   - ä¿®æ”¹é»˜è®¤æ•°æ®åº“å¯†ç 
   - ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
   - å¯ç”¨SSLè¿æ¥

2. **æ€§èƒ½ä¼˜åŒ–**
   - å¯ç”¨è¿æ¥æ±  (å·²é…ç½® `pool_pre_ping=True`)
   - å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯
   - ä¸ºé«˜é¢‘æŸ¥è¯¢æ·»åŠ ç´¢å¼•

3. **å¤‡ä»½ç­–ç•¥**
   - å®šæœŸå…¨é‡å¤‡ä»½
   - å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—
   - æµ‹è¯•æ¢å¤æµç¨‹

4. **æ•°æ®ä¸€è‡´æ€§**
   - å¤–é”®çº¦æŸå·²é€šè¿‡ SQLAlchemy å…³ç³»å®šä¹‰
   - ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
   - persona_cache åœ¨æˆæœå®¡æ ¸é€šè¿‡æ—¶è‡ªåŠ¨å¤±æ•ˆ

---

## ç‰ˆæœ¬ä¿¡æ¯

- **åˆ›å»ºæ—¥æœŸ**: 2026-01-19
- **æ•°æ®åº“ç‰ˆæœ¬**: MySQL 5.7+
- **ORMç‰ˆæœ¬**: SQLAlchemy 2.x
- **Pythonç‰ˆæœ¬**: 3.8+

---

**æœ€åæ›´æ–°**: 2026-01-19
